<!DOCTYPE HTML>
<html lang="">

<head>
    <!--Setting-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="apple-mobile-web-app-capable" content="Hexo">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    <meta name="browsermode" content="application">
    <meta name="screen-orientation" content="portrait">
    <meta name="theme-version" content="1.2.3">
    <meta name="root" content="/">
    <link rel="dns-prefetch" href="http://yoursite.com">
    <!--SEO-->

<meta name="keywords" content="esp8266 smartConfig" />


<meta name="description" content="1.开机去读取本机的/wifis.json文件里面的默认wifi去链接2.如果都链接不成功，开启smartConfig3.smartConfig不成功，自己开启wifi，连接后可控制板载led
..." />


<meta name="robots" content="all" />
<meta name="google" content="all" />
<meta name="googlebot" content="all" />
<meta name="verify" content="all" />
    <!--Title-->

<title>
    
    esp8266 smartConfit |
    
    Hexo
</title>

<link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">


<link rel="icon" href="/favicon.ico">

    


<link rel="stylesheet" href="/css/bootstrap.min.css?rev=3.3.7.css">
<link rel="stylesheet" href="/css/font-awesome.min.css?rev=4.7.0.css">
<link rel="stylesheet" href="/css/style.css?rev=@@hash.css">

    
<div class="hide">
    <script type="text/javascript">
    var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");
    document.write(unescape("%3Cspan class='cnzz_stat_icon_1263868967 hide' %3E%3Cscript%20src%3D%22https%3A%2F%2Fs95.cnzz.com%2Fz_stat.php%3Fweb_id%3D1272564536%22%3E%3C%2Fscript%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s19.cnzz.com/z_stat.php%3Fid%3D1263868967%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));
    </script>
</div>




    

<meta name="generator" content="Hexo 5.3.0"></head>
<!--[if lte IE 8]>
<style>
    html{ font-size: 1em }
</style>
<![endif]-->
<!--[if lte IE 9]>
<div style="ie">你使用的浏览器版本过低，为了你更好的阅读体验，请更新浏览器的版本或者使用其他现代浏览器，比如Chrome、Firefox、Safari等。</div>
<![endif]-->
<body>
    <header class="main-header"  style="background-image:url(
    http://snippet.shenliyang.com/img/banner.jpg)"
     >
    <div class="main-header-box">
        <a class="header-avatar" href="/" title='John Doe'>
            <img src="/img/avatar.jpg" alt="logo头像" class="img-responsive center-block">
        </a>
        <div class="branding">
            <!--<h2 class="text-hide">Snippet主题,从未如此简单有趣</h2>-->
            
            <img src="/img/branding.png" alt="Snippet 博客主题" class="img-responsive center-block">
            
        </div>
    </div>
</header>
    <nav class="main-navigation">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="navbar-header"><span class="nav-toggle-button collapsed pull-right" data-toggle="collapse" data-target="#main-menu" id="mnav">
                        <span class="sr-only"></span>
                        <i class="fa fa-bars"></i>
                    </span>
                    <a class="navbar-brand" href="http://yoursite.com">
                        Hexo</a>
                </div>
                <div class="collapse navbar-collapse" id="main-menu">
                    <ul class="menu">
                        
                        <li role="presentation" class="text-center">
                            <a href="/"><i class="fa "></i>
                                Home</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/categories/前端/"><i class="fa "></i>
                                前端</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/categories/后端/"><i class="fa "></i>
                                后端</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/categories/工具/"><i class="fa "></i>
                                工具</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/archives/"><i class="fa "></i>
                                时间轴</a>
                        </li>
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>
    <section class="content-wrap">
        <div class="container">
            <div class="row">
                <main class="col-md-8 main-content m-post">
                    <p id="process"></p>
<article class="post">
    <div class="post-head">
        <h1 id="esp8266 smartConfit">
            
            esp8266 smartConfit
            
        </h1>
        <div class="post-meta">
    
    <span class="categories-meta fa-wrap">
        <i class="fa fa-folder-open-o"></i>
        
    </span>
    
    
    <span class="fa-wrap">
        <i class="fa fa-tags"></i>
        <span class="tags-meta">
            
            <a class="tag-none-link" href="/tags/esp8266-smartConfig/" rel="tag">esp8266 smartConfig</a>
            
        </span>
    </span>
    
    
    
    <span class="fa-wrap">
        <i class="fa fa-clock-o"></i>
        <span class="date-meta">
            2021/01/08</span>
    </span>
    
    
</div>
        
        
    </div>
    
    <div class="post-body post-content">
        <p>1.开机去读取本机的/wifis.json文件里面的默认wifi去链接<br>2.如果都链接不成功，开启smartConfig<br>3.smartConfig不成功，自己开启wifi，连接后可控制板载led</p>
<pre><code>#include &lt;Arduino.h&gt;
#include &lt;ArduinoJson.h&gt;
#include &lt;ESP8266WiFi.h&gt;
#include &lt;ESP8266WiFiMulti.h&gt;
#include &lt;ESP8266WebServer.h&gt;
#include &lt;FS.h&gt;

ESP8266WiFiMulti wifiMulti;
DynamicJsonBuffer djb;

ESP8266WebServer server(80);

void smartConfig() &#123;
  //切换模式
  WiFi.mode(WIFI_STA);
  Serial.println(&quot;waitting for SmartConfig...&quot;);

  //开启smartConfig模式
  WiFi.beginSmartConfig();
  int i = 0;

  //等待
  while (!WiFi.smartConfigDone()) &#123;
    Serial.print(&quot;.&quot;);
    delay(1000);

    i++;

    //超时
    if (i == 30) &#123;
      Serial.println(&quot;smartConfig timeout 30s&quot;);
      WiFi.stopSmartConfig();
      break;
    &#125;
  &#125;

  //连接到了wifi 打印 写入配置文件
  if (wifiMulti.run() == WL_CONNECTED) &#123;
    Serial.println(&quot;smartConfig success&quot;);
    Serial.printf(&quot;SSID:%s\r\n&quot;, WiFi.SSID().c_str());
    Serial.printf(&quot;PSW:%s\r\n&quot;, WiFi.psk().c_str());
    wifiMulti.addAP(WiFi.SSID().c_str(), WiFi.psk().c_str());
    writeFile(WiFi.SSID().c_str(), WiFi.psk().c_str());
    ledCtrl(&quot;on&quot;);
  &#125; else &#123;
    //配置文件里面都不能连接 配置为服务器模式
    IPAddress softLocal(192, 168, 1, 1);
    IPAddress softGateway(192, 168, 1, 1);
    IPAddress softSubnet(255, 255, 255, 0);
    WiFi.softAPConfig(softLocal, softGateway, softSubnet);
    WiFi.softAP(&quot;esp8266-192.168.1.1&quot;, &quot;esp8266666&quot;);

    startServer();
  &#125;
&#125;

/**
   开始页面
*/
void homepage() &#123;
  String filecontend = readFile(&quot;/index.html&quot;);
  if (filecontend) &#123;
    server.send(200, &quot;text/html&quot;, filecontend);
  &#125; else &#123;
    Serial.println(&quot;index.html is empty&quot;);
  &#125;
&#125;

/**
 * 控制等
 */
void pin() &#123;
  String type = &quot;&quot;;
  if (server.arg(&quot;light&quot;) == &quot;on&quot;) &#123;
    type = &quot;on&quot;;
  &#125; else if (server.arg(&quot;light&quot;) == &quot;off&quot;) &#123;
    type = &quot;off&quot;;
  &#125;
  server.send(200, &quot;text/html&quot;, type);
  ledCtrl(type);
&#125;

/**
   启动服务
*/
void startServer() &#123;
  server.on(&quot;/&quot;, homepage);
  server.on(&quot;/pin&quot;, pin);
  server.begin();
  Serial.println(&quot;&quot;);
  Serial.print(&quot;server start on http://&quot;);
  Serial.print(WiFi.softAPIP());
  Serial.println(&quot;:80&quot;);
&#125;

/**
   把已连接的wifi 写入配置文件
*/
void writeFile(String ssid, String pwd) &#123;
  String fileContent = readFile(&quot;/wifis.json&quot;);
  if (fileContent != &quot;&quot;) &#123;
    JsonObject&amp; jo = djb.parse(fileContent);
    if (jo.containsKey(&quot;wifis&quot;)) &#123;
      JsonArray&amp; ja = jo[&quot;wifis&quot;];
      JsonObject&amp; newObj = djb.createObject();
      newObj[&quot;ssid&quot;] = ssid;
      newObj[&quot;pwd&quot;] = pwd;
      ja.add(newObj);
      //jo = djb.createObject();
      jo[&quot;wifis&quot;] = ja;
      File jsonFile = SPIFFS.open(&quot;/wifis.json&quot;, &quot;w+&quot;);
      if (jsonFile) &#123;
        jsonFile.print(jo.printTo(jsonFile));
        //打印
        jo.printTo(Serial);
      &#125; else &#123;
        Serial.println(&quot;wifis.json write failed&quot;);
      &#125;

      jsonFile.close();
    &#125;
  &#125;
&#125;

/**
   读取文件 返回文件内容
*/
String readFile(String filename) &#123;
  if (SPIFFS.begin()) &#123;
    Serial.println(&quot;SPIFFS started&quot;);
  &#125; else &#123;
    Serial.println(&quot;SPIFFS start failed&quot;);
  &#125;

  if (SPIFFS.exists(filename)) &#123;
    Serial.print(filename);
    Serial.println(&quot; Found ...&quot;);
  &#125; else &#123;
    Serial.print(filename);
    Serial.println(&quot; Not Found ...&quot;);
  &#125;
  File file = SPIFFS.open(filename, &quot;r&quot;);
  if (!file) &#123;
    Serial.println(filename + &quot;open failed&quot;);
  &#125;
  String fileContent = &quot;&quot;;
  if (file.size() &gt; 0) &#123;
    for (int i = 0; i &lt; file.size(); i++) &#123;
      fileContent += (char)file.read();
    &#125;

    Serial.println(fileContent);
  &#125; else &#123;
    Serial.println(filename + &quot; is empty&quot;);
  &#125;
  file.close();
  return fileContent;
&#125;

void setup() &#123;
  Serial.begin(2000000);
  //板载灯
  pinMode(LED_BUILTIN, OUTPUT);
  Serial.println();
  Serial.println(&quot;start to config&quot;);
  wifiMulti.run();

  //判断是否已自动连接到wifi
  if (wifiMulti.run() == WL_CONNECTED) &#123;
    Serial.print(&quot;&quot;);
    Serial.println(&quot;connect success&quot;);
    Serial.println(&quot;ip:&quot;);
    Serial.println(WiFi.localIP());
  &#125; else if (wifiMulti.run() != WL_CONNECTED) &#123;
    Serial.println(&quot;not connected&quot;);
    //先判断wifis.json是否有记录 有 读取 没有 smartConfig

    String fileContent = readFile(&quot;/wifis.json&quot;);
    if (fileContent != &quot;&quot;) &#123;
      WiFi.mode(WIFI_STA);
      JsonObject&amp; jo = djb.parse(fileContent);
      if (jo.containsKey(&quot;wifis&quot;)) &#123;
        JsonArray&amp; ja = jo[&quot;wifis&quot;];
        const char* ssid;
        const char* pwd;
        for (int i = 0; i &lt; ja.size(); i++) &#123;
          ssid = ja[i][&quot;ssid&quot;];
          pwd = ja[i][&quot;pwd&quot;];
          wifiMulti.addAP(ssid, pwd);
          Serial.println(&quot;connect by wifis.json&quot;);
          Serial.print(&quot;ssid:&quot;);
          Serial.println(ssid);
          Serial.print(&quot;pwd:&quot;);
          Serial.println(pwd);
          int j = 0;
          while (wifiMulti.run() != WL_CONNECTED) &#123;
            delay(500);
            j ++;
            //等待20s
            if (j == 20) &#123;
              Serial.print(&quot;connect to &quot;);
              Serial.print(ssid);
              Serial.println(&quot; failed:timeout 20s&quot;);
              break;
            &#125;
          &#125;

          //连接到了wifi 打印ip
          if (wifiMulti.run() == WL_CONNECTED) &#123;
            Serial.println(&quot;connect success&quot;);
            Serial.println(&quot;ip:&quot;);
            Serial.println(WiFi.localIP());
            ledCtrl(&quot;on&quot;);
          &#125;
        &#125;
      &#125; else &#123;
        Serial.println(&quot;wifis.json is empty&quot;);
      &#125;
    &#125;

    //从配置文件读取失败 开始smartConfig 配置
    if (wifiMulti.run() != WL_CONNECTED) &#123;
      smartConfig();
    &#125;
  &#125;
&#125;

void ledCtrl(String type) &#123;
  if (type == &quot;on&quot;) &#123;
    digitalWrite(LED_BUILTIN, LOW);
  &#125; else if (type == &quot;off&quot;) &#123;
    digitalWrite(LED_BUILTIN, HIGH);
  &#125;
&#125;

void loop() &#123;
  //监听客户请求并处理
  server.handleClient();
&#125;
</code></pre>
    </div>
    
    <div class="post-footer">
        <div>
            
            转载声明：
            商业转载请联系作者获得授权,非商业转载请注明出处 © <a href="" target="_blank">Snippet</a>
            
            
        </div>
        <div>
            
        </div>
    </div>
</article>
<div class="article-nav prev-next-wrap clearfix">
    
    
    <a href="/2019/10/28/mysql/" class="next-post btn btn-default" title='mysql'>
        <span class="hidden-lg">下一篇</span>
        <span class="hidden-xs">
            mysql</span><i class="fa fa-angle-right fa-fw"></i>
    </a>
    
</div>

<div id="comments">
    

<div id="vcomments" class="valine"></div>

<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="/assets/valine.min.js"></script>

<script>
new Valine({
    av: AV,
    el: '#vcomments',
    appId: 'QNr6zQWX8nzs9alWfAoG4KW9-gzGzoHsz',
    appKey: 'vALagihA6ROUf7XXp1sjDD2j',
    placeholder: '说点什么吧',
    notify: false,
    verify: true,
    avatar: 'mm',
    meta: 'nick,mail'.split(','),
    pageSize: '10',
    path: window.location.pathname,
    lang: ''.toLowerCase()
})
</script>


</div>

                </main>
                
                    <aside id="article-toc" role="navigation" class="col-md-4">
    <div class="widget">
        <h3 class="title">
            Table of Contents
        </h3>
        
        <p>暂无目录</p>
        
    </div>
</aside>
                
            </div>
        </div>
    </section>
    <footer class="main-footer">
    <div class="container">
        <div class="row">
        </div>
    </div>
</footer>
<a id="back-to-top" class="icon-btn hide">
    <i class="fa fa-chevron-up"></i>
</a>
    <div class="copyright">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="busuanzi">
    
</div>
            </div>
            <div class="col-sm-12">
                <span>Copyright &copy;
                    2017
                </span> |
                <span>
                    Powered by <a href="//hexo.io" class="copyright-links" target="_blank" rel="nofollow">Hexo</a>
                </span> |
                <span>
                    Theme by <a href="//github.com/shenliyang/hexo-theme-snippet.git" class="copyright-links" target="_blank" rel="nofollow">Snippet</a>
                </span>
            </div>
        </div>
    </div>
</div>




<script src="/js/app.js?rev=@@hash.js"></script>

</body>
</html>